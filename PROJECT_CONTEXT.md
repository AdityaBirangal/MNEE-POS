# MNEE POS - Complete Project Context

## Project Overview

**MNEE POS** is a point-of-sale (POS) application that enables merchants to accept instant MNEE stablecoin payments using the **x402 HTTP-402 payment protocol** on **Sepolia Testnet**. This project was built for the MNEE Hackathon under the "Commerce & Creator Tools" category.

### Key Features
- ✅ Invoice creation with custom amounts
- ✅ Payment URL and QR code generation
- ✅ Real-time payment status updates
- ✅ x402 HTTP 402 payment protocol integration
- ✅ Gasless transactions (via ERC4337 facilitator)
- ✅ Modern, responsive UI with mobile-first design
- ✅ Database persistence (PostgreSQL via Prisma)
- ✅ PDF invoice download capability

---

## Tech Stack

### Core Technologies
- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **Payment Protocol**: x402 HTTP 402 (via Thirdweb SDK v5)
- **Blockchain**: Sepolia Testnet (Ethereum)
- **Token**: MNEE (6 decimals, contract: `0x2F039630031C2C56E40bB9Ff729504E016765730`)
- **Wallet Integration**: Thirdweb React SDK
- **Database**: PostgreSQL (via Prisma ORM)
- **UI Libraries**: React 19, html2canvas, jspdf, qrcode.react

### Key Dependencies
```json
{
  "next": "16.0.7",
  "react": "19.2.1",
  "thirdweb": "^5.112.4",
  "@prisma/client": "^5.22.0",
  "html2canvas": "^1.4.1",
  "jspdf": "^3.0.4",
  "qrcode.react": "^4.2.0"
}
```

---

## Project Structure

```
MNEE-POS/
├── app/
│   ├── api/
│   │   ├── invoices/
│   │   │   ├── route.ts                    # POST /api/invoices - Create invoice
│   │   │   └── [id]/status/
│   │   │       └── route.ts               # GET /api/invoices/:id/status
│   │   └── pay/
│   │       └── [invoiceId]/
│   │           └── route.ts                # GET /api/pay/:invoiceId (x402 endpoint)
│   ├── components/
│   │   ├── QRCodeCard.tsx                  # QR code display component
│   │   ├── StatusBadge.tsx                # Payment status badge
│   │   └── Toast.tsx                      # Toast notification component
│   ├── invoice/
│   │   └── [invoiceId]/
│   │       └── page.tsx                   # Merchant invoice details page
│   ├── pay/
│   │   └── [invoiceId]/
│   │       └── page.tsx                   # Customer payment page
│   ├── page.tsx                           # Merchant dashboard (home)
│   ├── layout.tsx                         # Root layout
│   └── globals.css                        # Global styles
├── lib/
│   ├── constants.ts                       # Network and token constants
│   ├── db/
│   │   └── prisma.ts                      # Prisma client singleton
│   ├── invoiceRepository.ts              # Database operations (Prisma)
│   ├── invoices.ts                       # Legacy utility functions
│   ├── payment.ts                        # Payment signature normalization
│   └── types.ts                          # TypeScript interfaces
├── prisma/
│   ├── schema.prisma                     # Database schema
│   └── migrations/                       # Database migrations
├── public/
│   ├── manifest.json                     # PWA manifest
│   ├── MNEE_Logo.png
│   └── MNEE_POS_icon.png
└── memory-bank/                         # Development documentation
```

---

## Database Schema

### Invoice Model (Prisma)
```prisma
model Invoice {
  id              String   @id              // 10-character uppercase hex ID
  amount          String                     // Amount in MNEE units (6 decimals)
  currency        String   @default("MNEE")
  status          String   @default("pending") // "pending" | "paid"
  merchantAddress String                     // Receiver address (merchant)
  senderAddress   String?                    // Sender address (customer) - set on payment
  queueID         String?                    // Queue ID from x402 payment receipt (UUID)
  paymentUrl      String                     // Payment URL for this invoice
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([merchantAddress])
  @@index([status])
  @@map("invoices")
}
```

**Key Points:**
- Invoice IDs are 10-character uppercase hex strings (generated by application)
- Amounts stored as strings in MNEE units (6 decimals, e.g., "1000000" = $1.00)
- `queueID` is a UUID from x402 payment receipt, NOT a blockchain transaction hash
- Status is stored as string but enforced as "pending" | "paid" by application logic

---

## API Endpoints

### 1. POST /api/invoices
**Purpose**: Create a new invoice

**Request Body:**
```json
{
  "amount": 10.50,
  "currency": "MNEE",
  "merchantAddress": "0x1234..."
}
```

**Response:**
```json
{
  "invoiceId": "A1B2C3D4E5",
  "amount": "10500000",
  "currency": "MNEE",
  "status": "pending",
  "paymentUrl": "http://localhost:3000/pay/A1B2C3D4E5",
  "createdAt": "2024-12-08T16:30:00.000Z"
}
```

**Implementation**: `app/api/invoices/route.ts`
- Validates amount > 0 and merchantAddress required
- Converts USD to MNEE units (6 decimals)
- Generates 10-character hex invoice ID
- Saves to database via `invoiceRepository.createInvoice()`

---

### 2. GET /api/invoices/[id]/status
**Purpose**: Get real-time invoice status

**Response (pending):**
```json
{
  "invoiceId": "A1B2C3D4E5",
  "status": "pending",
  "amount": "10500000",
  "currency": "MNEE",
  "receiverAddress": "0x1234...",
  "createdAt": "2024-12-08T16:30:00.000Z",
  "updatedAt": "2024-12-08T16:30:00.000Z"
}
```

**Response (paid):**
```json
{
  "invoiceId": "A1B2C3D4E5",
  "status": "paid",
  "amount": "10500000",
  "currency": "MNEE",
  "receiverAddress": "0x1234...",
  "senderAddress": "0x5678...",
  "queueID": "abc123-def456-...",
  "createdAt": "2024-12-08T16:30:00.000Z",
  "updatedAt": "2024-12-08T16:35:00.000Z"
}
```

**Implementation**: `app/api/invoices/[id]/status/route.ts`
- Fetches invoice from database
- Returns real-time status (no caching)

---

### 3. GET /api/pay/[invoiceId]
**Purpose**: x402 payment protocol endpoint

**Flow:**
1. **First Request (No Payment)**: Returns HTTP 402 with payment details in headers
2. **Wallet reads headers** and prepares payment with signature
3. **Second Request (With X-PAYMENT header)**: Verifies and processes payment
4. **On Success**: Returns HTTP 200 and marks invoice as paid

**Implementation**: `app/api/pay/[invoiceId]/route.ts`

**Key Logic:**
- Uses Thirdweb's `settlePayment` to handle x402 protocol
- EIP712 configuration for MNEE token (ERC-2612 Permit)
- Payment processed via ERC4337 UserOperation batching
- Facilitator (Smart Account) executes transaction
- Gas fees paid by facilitator (gasless for customer)
- Extracts Queue ID (UUID) from payment receipt
- Updates invoice status to "paid" in database

**EIP712 Configuration:**
```typescript
{
  name: "USDA", // Token name (configurable via MNEE_EIP712_NAME env var)
  version: "1", // EIP712 version (configurable via MNEE_EIP712_VERSION env var)
  primaryType: "Permit" // ERC-2612 Permit (not ERC-3009)
}
```

**Payment Receipt Structure:**
- `paymentReceipt.transaction` contains Queue ID (UUID), NOT blockchain tx hash
- Queue ID format: `5d910d82-ba36-48a7-982e-b4ff3081b81f`
- Sender address extracted from payment data or receipt

---

## Frontend Pages

### 1. `/` - Merchant Dashboard
**File**: `app/page.tsx`

**Features:**
- Wallet connection (Thirdweb ConnectButton)
- Invoice creation form (amount input)
- Redirects to invoice details page after creation
- Mobile-first responsive design

**Key Components:**
- `ConnectButton` with MNEE balance display
- Amount input with validation
- Toast notifications

---

### 2. `/invoice/[invoiceId]` - Invoice Details (Merchant View)
**File**: `app/invoice/[invoiceId]/page.tsx`

**Features:**
- QR code display (prominently shown first)
- Invoice information (amount, status, ID, payment URL)
- Real-time status polling (every 3 seconds if pending)
- Copy-to-clipboard for payment URL
- Status badge with icons
- Queue ID display (if paid)
- Back button to dashboard

**Key Components:**
- `QRCodeCard` - QR code display
- `StatusBadge` - Status indicator
- `Toast` - Notifications

---

### 3. `/pay/[invoiceId]` - Customer Payment Page
**File**: `app/pay/[invoiceId]/page.tsx`

**Features:**
- Invoice details display
- Wallet connection
- Payment button (triggers x402 payment)
- Payment confirmation screen (after successful payment)
- PDF invoice download (using html2canvas + jspdf)
- Payment receipt with full details

**Payment Flow:**
1. Customer visits payment page
2. Connects wallet (must be on Sepolia testnet)
3. Clicks "Pay with Wallet"
4. Wallet reads x402 headers from `/api/pay/[invoiceId]`
5. Wallet prepares payment signature
6. Payment request sent with `X-PAYMENT` header
7. Payment processed via ERC4337 facilitator
8. Success screen shown with receipt
9. PDF download available

**Key Implementation Details:**
- Uses `wrapFetchWithPayment` from Thirdweb x402 SDK
- Signature normalization via `createNormalizedFetch` (for Sepolia compatibility)
- Real-time status updates after payment

---

## Library Modules

### `lib/constants.ts`
Network and token configuration:
- Chain ID: 11155111 (Sepolia Testnet)
- MNEE Address: `0x2F039630031C2C56E40bB9Ff729504E016765730`
- MNEE Decimals: 6
- API Base URL configuration

### `lib/types.ts`
TypeScript interfaces:
- `Invoice` - Invoice data structure
- `CreateInvoiceRequest` - Invoice creation request
- `InvoiceStatusResponse` - Status endpoint response

### `lib/invoiceRepository.ts`
Database operations using Prisma:
- `createInvoice()` - Create new invoice
- `getInvoiceById()` - Fetch invoice by ID
- `markInvoicePaid()` - Update invoice status to paid
- `listInvoicesByMerchant()` - List invoices by merchant address

**Key Features:**
- Generates 10-character uppercase hex invoice IDs
- Converts USD to MNEE units (6 decimals)
- Handles Queue ID and sender address extraction

### `lib/payment.ts`
Payment signature normalization:
- `createNormalizedFetch()` - Creates normalized fetch for Sepolia
- Handles EIP-155 signature v value conversion
- Required for x402 payment signatures on Sepolia

### `lib/db/prisma.ts`
Prisma client singleton:
- Prevents multiple instances in Next.js dev mode
- Uses `globalThis.__prisma` for persistence
- Configured with logging (queries in dev, errors in prod)

---

## Environment Variables

Required in `.env.local`:

```env
# Thirdweb Configuration
NEXT_PUBLIC_THIRDWEB_CLIENT_ID=your_client_id_here
THIRDWEB_SECRET_KEY=your_secret_key_here

# Facilitator Wallet (ERC4337 Smart Account address)
THIRDWEB_SERVER_WALLET_ADDRESS=0x...

# API Base URL
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/mnee_pos

# Optional: EIP712 Configuration (for debugging)
MNEE_EIP712_NAME=USDA
MNEE_EIP712_VERSION=1
```

---

## Payment Flow (Detailed)

### Step 1: Invoice Creation
1. Merchant connects wallet on dashboard
2. Enters amount (USD)
3. Clicks "Create Invoice"
4. POST `/api/invoices` creates invoice in database
5. Redirects to `/invoice/[invoiceId]`

### Step 2: Payment Initiation
1. Customer visits `/pay/[invoiceId]` (via QR code or link)
2. Customer connects wallet (Sepolia testnet)
3. Clicks "Pay with Wallet"
4. Frontend calls `/api/pay/[invoiceId]` with `wrapFetchWithPayment`

### Step 3: x402 Payment Protocol
1. **First Request**: Server returns HTTP 402 with payment headers
2. Wallet reads headers and prepares EIP712 signature
3. **Second Request**: Wallet sends request with `X-PAYMENT` header
4. Server calls `settlePayment()` from Thirdweb SDK
5. Payment verified and processed via ERC4337 facilitator
6. MNEE transferred from customer to merchant
7. Gas fees paid by facilitator (gasless for customer)

### Step 4: Payment Confirmation
1. `settlePayment` returns status 200 on success
2. Queue ID extracted from `paymentReceipt.transaction`
3. Sender address extracted from payment data
4. Invoice updated in database via `markInvoicePaid()`
5. Status changed to "paid"
6. Customer sees success screen with receipt

### Step 5: Status Updates
1. Merchant page polls `/api/invoices/[id]/status` every 3 seconds
2. Status updates from "pending" to "paid"
3. Toast notification shown on merchant side
4. Queue ID displayed in invoice details

---

## Important Technical Notes

### Queue ID vs Transaction Hash
**Critical Understanding:**
- x402 uses ERC4337 UserOperation batching
- Payments go through a queue system
- The `paymentReceipt.transaction` field is a **Queue ID (UUID)**, NOT a blockchain transaction hash
- Example Queue ID: `5d910d82-ba36-48a7-982e-b4ff3081b81f`
- The actual blockchain transaction hash is not available in the payment receipt
- To get the on-chain hash, you would need to query the facilitator or blockchain explorer separately

**Implementation:**
- Invoice stores `queueID` (not `txHash`)
- UI displays Queue ID when available
- This is the correct behavior for x402 payments

### EIP712 Configuration
The MNEE token uses ERC-2612 Permit (not ERC-3009 TransferWithAuthorization). EIP712 domain parameters:
- **name**: "USDA" (configurable via `MNEE_EIP712_NAME` env var)
- **version**: "1" (configurable via `MNEE_EIP712_VERSION` env var)
- **primaryType**: "Permit"

If payment simulation fails, verify:
1. Token name matches contract's `name()` exactly (case-sensitive)
2. EIP712 version matches contract's domain separator
3. Contract supports ERC-2612 `permit()` function

### Signature Normalization
Sepolia uses EIP-155 with chain ID 11155111. Signature `v` values need normalization for proper verification. Handled in `lib/payment.ts` via `createNormalizedFetch()`.

### Database Persistence
- Uses PostgreSQL via Prisma ORM
- Prisma client is a singleton (prevents multiple instances)
- All invoices persist across server restarts
- Invoice IDs are 10-character uppercase hex (application-generated)

---

## Component Details

### QRCodeCard Component
**File**: `app/components/QRCodeCard.tsx`
- Displays QR code using `qrcode.react`
- Shows payment URL
- Mobile-responsive

### StatusBadge Component
**File**: `app/components/StatusBadge.tsx`
- Visual status indicator
- Icons for pending/paid states
- Multiple size options (small, medium, large)

### Toast Component
**File**: `app/components/Toast.tsx`
- Toast notifications
- Types: success, error, info
- Auto-dismiss after 3 seconds

---

## Development Scripts

```bash
# Development
npm run dev              # Start dev server

# Database
npm run prisma:generate  # Generate Prisma client
npm run prisma:migrate   # Run migrations (dev)
npm run prisma:studio    # Open Prisma Studio

# Build
npm run build            # Build for production
npm run start            # Start production server
```

---

## Testing

### Manual Testing Flow
1. **Create Invoice**: Connect wallet → Enter amount → Create invoice
2. **View Invoice**: Check QR code, payment URL, status
3. **Make Payment**: Visit payment page → Connect wallet → Pay
4. **Verify Status**: Check status updates on merchant page
5. **Download PDF**: Test PDF generation after payment

### API Testing
- Use test scripts in `memory-bank/` directory
- Test invoice creation via POST `/api/invoices`
- Test status checking via GET `/api/invoices/[id]/status`
- Test payment endpoint via GET `/api/pay/[invoiceId]`

---

## Known Issues & Solutions

### Issue 1: Payment Simulation Failed
**Problem**: EIP712 domain parameters don't match contract
**Solution**: Verify token name and version match contract exactly. Use env vars to override.

### Issue 2: Invoice Not Found After Restart
**Problem**: Database connection issues
**Solution**: Ensure DATABASE_URL is correctly configured. Check Prisma client initialization.

### Issue 3: Signature Verification Failed
**Problem**: Signature normalization issues
**Solution**: Ensure `createNormalizedFetch` is used for Sepolia compatibility.

---

## Future Enhancements

- [ ] Multiple currency support
- [ ] Invoice history and analytics dashboard
- [ ] Webhook notifications
- [ ] Multi-merchant support
- [ ] Email receipts
- [ ] Blockchain transaction hash lookup (from Queue ID)
- [ ] Invoice templates
- [ ] Recurring payments

---

## Deployment

### Vercel Deployment
- Configure environment variables in Vercel dashboard
- Set up PostgreSQL database (Vercel Postgres or external)
- Run migrations: `npm run prisma:migrate:deploy`
- Deploy via Git integration

### Database Migration
- Development: SQLite (file: `./dev.db`)
- Production: PostgreSQL (configure DATABASE_URL)
- Migrations: Use Prisma migrations

---

## Project Status

**Current Status**: ✅ Production Ready
- ✅ All core features implemented
- ✅ Database integration complete
- ✅ Payment flow tested and working
- ✅ UI polished and responsive
- ✅ Documentation complete

**Hackathon Submission**: Commerce & Creator Tools category
- Demonstrates checkout and payment acceptance using MNEE stablecoin
- Point-of-sale infrastructure for merchants
- Real-world commerce application using programmable money

---

## Resources

- **GitHub**: https://github.com/AdityaBirangal/MNEE-POS
- **MNEE Contract**: `0x2F039630031C2C56E40bB9Ff729504E016765730` on Sepolia Testnet
- **MNEE Website**: https://mnee.io
- **Hackathon**: https://mnee-eth.devpost.com
- **Thirdweb x402 Docs**: https://portal.thirdweb.com/x402

---

## Key Files Reference

- **Invoice Creation**: `app/api/invoices/route.ts`
- **Status Check**: `app/api/invoices/[id]/status/route.ts`
- **Payment Processing**: `app/api/pay/[invoiceId]/route.ts`
- **Database Operations**: `lib/invoiceRepository.ts`
- **Database Schema**: `prisma/schema.prisma`
- **Merchant Dashboard**: `app/page.tsx`
- **Invoice Details**: `app/invoice/[invoiceId]/page.tsx`
- **Payment Page**: `app/pay/[invoiceId]/page.tsx`
- **Constants**: `lib/constants.ts`
- **Types**: `lib/types.ts`

---

This document provides comprehensive context about the MNEE POS project. Use it to understand the architecture, implementation details, and how all components work together.
